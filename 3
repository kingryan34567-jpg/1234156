// Code.gs
function doPost(e) {
  try {
    // è§£æå‚³å…¥çš„è³‡æ–™
    var data = JSON.parse(e.postData.contents);

    // é€£æ¥åˆ° Google Sheetï¼ˆç¬¬ä¸€æ¬¡åŸ·è¡Œæœƒè‡ªå‹•å»ºç«‹ï¼‰
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('å ±åè³‡æ–™');

    // å¦‚æœå·¥ä½œè¡¨ä¸å­˜åœ¨ï¼Œå»ºç«‹æ–°çš„
    if (!sheet) {
      sheet = ss.insertSheet('å ±åè³‡æ–™');
      // å»ºç«‹æ¨™é¡Œåˆ—
      sheet.appendRow([
        'å ±åæ™‚é–“', 
        'å§“å', 
        'å­¸è™Ÿ', 
        'é›»å­éƒµä»¶', 
        'é›»è©±', 
        'ç³»æ‰€', 
        'åƒåŠ å ´æ¬¡', 
        'èˆˆè¶£æ´»å‹•'
      ]);

      // è¨­å®šæ¨™é¡Œåˆ—æ ¼å¼
      var headerRange = sheet.getRange(1, 1, 1, 8);
      headerRange.setBackground('#667eea');
      headerRange.setFontColor('#ffffff');
      headerRange.setFontWeight('bold');
    }

    // æ–°å¢è³‡æ–™åˆ°å·¥ä½œè¡¨
    sheet.appendRow([
      new Date().toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'}),
      data.name,
      data.studentId,
      data.email,
      data.phone,
      data.department,
      data.session,
      data.activities.join(', ')
    ]);

    // ç™¼é€éƒµä»¶é€šçŸ¥ï¼ˆè«‹ä¿®æ”¹æˆä½ çš„ Gmail åœ°å€ï¼‰
    var emailBody = 
      'ğŸ‰ æ–°çš„è¿æ–°æ´»å‹•å ±å\n\n' +
      'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
      'å§“åï¼š' + data.name + '\n' +
      'å­¸è™Ÿï¼š' + data.studentId + '\n' +
      'é›»å­éƒµä»¶ï¼š' + data.email + '\n' +
      'é›»è©±ï¼š' + data.phone + '\n' +
      'ç³»æ‰€ï¼š' + data.department + '\n' +
      'åƒåŠ å ´æ¬¡ï¼š' + data.session + '\n' +
      'èˆˆè¶£æ´»å‹•ï¼š' + data.activities.join(', ') + '\n' +
      'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n' +
      'å ±åæ™‚é–“ï¼š' + new Date().toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'}) + '\n\n' +
      'ğŸ“Š æŸ¥çœ‹å®Œæ•´è³‡æ–™ï¼š' + ss.getUrl();

    // âš ï¸ é‡è¦ï¼šè«‹å°‡ä¸‹é¢çš„ä¿¡ç®±æ”¹æˆä½ çš„ Gmail åœ°å€
    MailApp.sendEmail({
      to: 'kingryan34567@gmail.com',
      subject: 'ğŸ‰ æ–°çš„è¿æ–°æ´»å‹•å ±å - ' + data.name,
      body: emailBody
    });

    // å›å‚³æˆåŠŸè¨Šæ¯
    return ContentService
      .createTextOutput(JSON.stringify({
        'result': 'success',
        'message': 'å ±åæˆåŠŸ'
      }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch(error) {
    // å›å‚³éŒ¯èª¤è¨Šæ¯
    Logger.log('éŒ¯èª¤ï¼š' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({
        'result': 'error',
        'message': error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// æ¸¬è©¦å‡½æ•¸
function test() {
  var testData = {
    postData: {
      contents: JSON.stringify({
        name: 'æ¸¬è©¦å­¸ç”Ÿ',
        studentId: 'A123456789',
        email: '123456789@example.com',
        phone: '0912345678',
        department: 'è³‡è¨Šå·¥ç¨‹ç³»',
        session: 'ä¸Šåˆå ´',
        activities: ['åœ˜åº·éŠæˆ²', 'æ ¡åœ’å°è¦½']
      })
    }
  };

  var result = doPost(testData);
  Logger.log(result.getContent());
}
