<?php
// submit.php
function safe($s){ return htmlspecialchars(trim($s), ENT_QUOTES, 'UTF-8'); }

// --- 接收表單資料 ---
$name = $_POST['name'] ?? '';
$stu  = $_POST['stu'] ?? '';
$phone= $_POST['phone'] ?? '';
$email= $_POST['email'] ?? '';
$dept = $_POST['dept'] ?? [];
$stay = $_POST['stay'] ?? '';
$meal = $_POST['meal'] ?? '';
$note = $_POST['note'] ?? '';

$name = safe($name);
$stu = safe($stu);
$phone = safe($phone);
$email = safe($email);
$stay = safe($stay);
$meal = safe($meal);
$note = safe($note);

// --- 防呆檢查 ---
$errors = [];
if (!$name) $errors[] = '姓名必填';
if (!$stu) $errors[] = '學號必填';
if (!$phone) $errors[] = '電話必填';
if (!$email || !filter_var($email, FILTER_VALIDATE_EMAIL)) $errors[] = 'Email 格式錯誤';
if (count($dept) < 1) $errors[] = '請選擇至少一個系所';
if (!$stay) $errors[] = '請選擇是否住宿';

if ($errors) {
  echo "<h2>欄位錯誤</h2><ul>";
  foreach ($errors as $e) echo "<li>$e</li>";
  echo "</ul><p><a href='index.html'>返回表單</a></p>";
  exit;
}

// --- 建立 uploads 資料夾 ---
$upload_dir = __DIR__ . '/uploads';
if (!is_dir($upload_dir)) mkdir($upload_dir, 0755, true);

// --- 1) 產生 PDF ---
require_once __DIR__ . '/libs/tcpdf/tcpdf.php';

$pdf_filename = "s{$stu}_HW2_registration.pdf";
$pdf_path = $upload_dir . '/' . $pdf_filename;

$pdf = new TCPDF();
$pdf->AddPage();
$pdf->SetFont('helvetica', '', 12);

$html = "<h2>四系迎新報名表</h2>
<table border='1' cellpadding='4'>
<tr><td><b>姓名</b></td><td>$name</td><td><b>學號</b></td><td>$stu</td></tr>
<tr><td><b>電話</b></td><td>$phone</td><td><b>Email</b></td><td>$email</td></tr>
<tr><td><b>系所</b></td><td colspan='3'>" . implode(', ', array_map('htmlspecialchars', $dept)) . "</td></tr>
<tr><td><b>是否住宿</b></td><td>$stay</td><td><b>飲食</b></td><td>$meal</td></tr>
<tr><td colspan='4'><b>備註</b><br>$note</td></tr>
</table>";

$pdf->writeHTML($html);
$pdf->Output($pdf_path, 'F');

// --- 2) 產生 QR Code ---
require_once __DIR__ . '/libs/phpqrcode/qrlib.php';
$base_url = 'http://localhost/HW2'; // ⚠️ 改成你實際的網址
$pdf_public_url = $base_url . '/uploads/' . rawurlencode($pdf_filename);
$qrfile = $upload_dir . '/qr_s' . $stu . '.png';
QRcode::png($pdf_public_url, $qrfile, QR_ECLEVEL_M, 6);

// --- 3) 嘗試寄信 ---
$to = $email;
$subject = "【迎新報名確認】$name (學號：$stu)";
$headers = "From: no-reply@yourdomain.edu.tw\r\n";
$headers .= "MIME-Version: 1.0\r\n";
$boundary = md5(time());
$headers .= "Content-Type: multipart/mixed; boundary=\"$boundary\"\r\n";

$message = "--$boundary\r\n";
$message .= "Content-Type: text/html; charset=UTF-8\r\n\r\n";
$message .= "<p>親愛的 $name，您好：</p>
<p>已收到您的報名資料，詳情如下：</p>
<ul>
<li>姓名：$name</li>
<li>學號：$stu</li>
<li>電話：$phone</li>
<li>系所：" . implode(', ', array_map('htmlspecialchars', $dept)) . "</li>
<li>住宿：$stay</li>
<li>飲食：$meal</li>
</ul>
<p>報名表 PDF：<a href=\"$pdf_public_url\">$pdf_public_url</a></p>
<p>祝您一切順心！</p>\r\n\r\n";

// 附件 PDF
$pdf_content = chunk_split(base64_encode(file_get_contents($pdf_path)));
$message .= "--$boundary\r\n";
$message .= "Content-Type: application/pdf; name=\"$pdf_filename\"\r\n";
$message .= "Content-Transfer-Encoding: base64\r\n";
$message .= "Content-Disposition: attachment; filename=\"$pdf_filename\"\r\n\r\n$pdf_content\r\n";

// 附件 QR Code
$qr_content = chunk_split(base64_encode(file_get_contents($qrfile)));
$message .= "--$boundary\r\n";
$message .= "Content-Type: image/png; name=\"qr_s{$stu}.png\"\r\n";
$message .= "Content-Transfer-Encoding: base64\r\n";
$message .= "Content-Disposition: attachment; filename=\"qr_s{$stu}.png\"\r\n\r\n$qr_content\r\n";
$message .= "--$boundary--";

$sent = mail($to, $subject, $message, $headers);

// --- 顯示結果 ---
echo "<h2>報名成功</h2>";
echo "<p>PDF 已產生：<a href='uploads/" . rawurlencode($pdf_filename) . "'>下載 PDF</a></p>";
echo "<p>QR Code 圖片：<a href='uploads/qr_s" . rawurlencode($stu) . ".png'>查看 QR</a></p>";
echo "<p>確認信寄送：" . ($sent ? "✅ 成功" : "⚠️ 未寄出（mail() 未啟用）") . "</p>";
?>
